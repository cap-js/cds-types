name: Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    strategy:
      matrix:
        version: [20, 18]
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.version }}

    - run: |
        npm ci
        npm install file:. --no-save --force

    - run: |
        npm run prerelease:ci-fix
        npm run rollup:off

    # Add a conditional step for creating a non-admin user on Windows
    - name: Create non-admin user
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $password = ConvertTo-SecureString "kragZTWET53$%" -AsPlainText -Force
        New-LocalUser "nonadmin" -Password $password
        Add-LocalGroupMember -Group "Users" -Member "nonadmin"
        runas /user:nonadmin "npm run test"

    - name: Run Unit Tests
      if: matrix.os != 'windows-latest'
      run: |
        npm run test

    - run: |
        npm run rollup && npm run rollup:on
        npm run test
